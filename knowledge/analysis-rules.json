{
  "$schema": "./schemas/analysis-rules.schema.json",
  "version": "1.0.0",
  "description": "Rules for AI analysis - what IS and IS NOT a violation. Edit this to tune AI behavior without changing code.",

  "violationTypes": {
    "hardcodedSecrets": {
      "id": "AI_HARDCODED_SECRET",
      "name": "Hardcoded Secret",
      "severity": "error",
      "description": "Literal credential strings embedded in source code",
      "isViolation": [
        "Literal token strings: const token = \"EAABx7...\"",
        "Hardcoded app secrets: app_secret = \"abc123def456\"",
        "API keys as string literals in code",
        "Credentials in config files committed to repo"
      ],
      "notViolation": [
        "Environment variables: process.env.TOKEN, process.env.API_KEY",
        "Config objects: config.secret, settings.apiKey",
        "Function parameters receiving credentials",
        "Secrets from vault services (AWS SSM, HashiCorp Vault)",
        "Encrypted or hashed values",
        "Placeholder strings: \"YOUR_TOKEN_HERE\", \"<api-key>\""
      ],
      "docs": ["accessTokens"]
    },

    "dataSharing": {
      "id": "AI_DATA_SHARING",
      "name": "Unauthorized Data Sharing",
      "severity": "error",
      "description": "Sending Meta user data to non-Meta third party services",
      "isViolation": [
        "Sending user data to external analytics: fetch('https://analytics.com', {body: userData})",
        "Posting PII to non-Meta webhooks",
        "Exporting user lists to third-party CRMs without consent",
        "Sharing access tokens with external services"
      ],
      "notViolation": [
        "Displaying images from URLs (rendering media)",
        "Returning data to the authenticated user",
        "Internal logging without PII/tokens",
        "Sending data to Meta's own APIs",
        "Server-to-server within same organization",
        "Analytics on aggregated/anonymized data"
      ],
      "docs": ["dataUse", "developerPolicies"]
    },

    "dataRetention": {
      "id": "AI_DATA_RETENTION",
      "name": "Data Retention Violation",
      "severity": "warning",
      "description": "Storing user data beyond allowed timeframes without proper controls",
      "isViolation": [
        "Permanent storage of user profiles without TTL",
        "Caching user data with no expiry (TTL=0 or forever)",
        "No data deletion mechanism for user requests",
        "Storing data without refresh mechanism beyond 24 hours"
      ],
      "notViolation": [
        "Cache with TTL <= 24 hours",
        "Database with cleanup/purge jobs",
        "Soft-delete with scheduled hard-delete",
        "Data refreshed on each access",
        "Aggregated/anonymized historical data"
      ],
      "docs": ["dataRetention", "dataUse"]
    },

    "automationAbuse": {
      "id": "AI_AUTOMATION_ABUSE",
      "name": "Automation Policy Violation",
      "severity": "error",
      "description": "Bulk operations or automation without proper controls",
      "isViolation": [
        "Infinite loops sending messages without delays",
        "Bulk DMs without user-initiated action",
        "Scraping without rate limiting",
        "Automated posting exceeding rate limits",
        "Bot behavior without proper disclosure"
      ],
      "notViolation": [
        "Queued job processors with delays",
        "Batch operations respecting rate limits",
        "SDK-based automation (handles limits internally)",
        "User-triggered bulk actions with confirmation",
        "Scheduled posts within limits"
      ],
      "docs": ["rateLimiting", "messengerPolicy", "instagramMessaging"]
    },

    "policyCircumvention": {
      "id": "AI_POLICY_CIRCUMVENTION",
      "name": "Policy Circumvention",
      "severity": "error",
      "description": "Deliberately bypassing Meta's security or policy controls",
      "isViolation": [
        "Using undocumented/private API endpoints",
        "Faking user agents or headers to bypass detection",
        "Scraping web UI instead of using official APIs",
        "Circumventing rate limits via multiple accounts",
        "Accessing data without proper permissions"
      ],
      "notViolation": [
        "Using official Graph API endpoints",
        "Standard SDK method calls",
        "Requesting additional permissions through proper flow",
        "Implementing retry logic with backoff"
      ],
      "docs": ["platformTerms", "developerPolicies"]
    },

    "webhookSecurity": {
      "id": "AI_WEBHOOK_SECURITY",
      "name": "Webhook Security Issue",
      "severity": "error",
      "description": "Webhook handlers without proper signature verification",
      "isViolation": [
        "Processing webhooks without X-Hub-Signature-256 check",
        "Using timing-unsafe string comparison for signatures",
        "Logging full webhook payloads with user data"
      ],
      "notViolation": [
        "Verification in middleware (check full handler chain)",
        "Using official SDK webhook verification",
        "Signature check before any processing",
        "Verification in API gateway/proxy layer"
      ],
      "docs": ["webhookSecurity", "webhooks"]
    },

    "messagingViolation": {
      "id": "AI_MESSAGING_VIOLATION",
      "name": "Messaging Policy Violation",
      "severity": "error",
      "description": "Violations of platform messaging rules",
      "isViolation": [
        "Automated DMs without user-initiated action",
        "Messages outside 24-hour window without approval",
        "Bulk unsolicited promotional messages",
        "Messaging users who haven't interacted with your app"
      ],
      "notViolation": [
        "Responses to user messages within 24h window",
        "Approved message templates (WhatsApp)",
        "One-time notification with user permission",
        "Customer service responses"
      ],
      "docs": ["instagramMessaging", "messengerPolicy", "whatsappPolicy"]
    },

    "dataStorageViolation": {
      "id": "AI_DATA_STORAGE",
      "name": "Data Storage Violation",
      "severity": "warning",
      "description": "Storing Meta user data in ways that may violate platform policies",
      "isViolation": [
        "Database tables storing raw user PII without encryption",
        "Schema storing access_token or app_secret in plain text columns",
        "Tables with user_email, user_phone without clear retention policy",
        "Storing user profile data (fb_id, ig_id) without TTL or cleanup mechanism",
        "Database schema with no apparent data deletion capability",
        "Caching user tokens/secrets without expiry",
        "Storing conversation/message history indefinitely"
      ],
      "notViolation": [
        "Schema with TTL columns or expiry timestamps",
        "Tables with soft_delete or deleted_at columns",
        "Encrypted credential storage (encrypted_token, secret_hash)",
        "Audit tables with clear retention period comments",
        "Reference tables (platforms, settings) without user data",
        "Storing only anonymized/aggregated user metrics",
        "Schema for app's own data (rules, configurations)"
      ],
      "docs": ["dataRetention", "dataUse", "developerPolicies"]
    }
  },

  "analysisGuidelines": {
    "approach": [
      "Focus on what code ACTUALLY DOES, not what it might do",
      "Consider that auth, rate limiting, validation often happen in middleware",
      "Check codebase context before assuming something is missing",
      "If uncertain, it's probably not a violation",
      "Only flag with confidence >= 0.85 for clear violations"
    ],
    "neverFlag": [
      "Import/export statements, type definitions, interfaces",
      "Comments, documentation, or disabled/commented code",
      "Standard Meta API calls (that's the intended use)",
      "Code where security is handled elsewhere in the codebase",
      "Environment variable usage (process.env.*)",
      "Configuration file references"
    ],
    "confidenceGuidelines": {
      "0.95+": "Absolutely certain - literal hardcoded secret visible",
      "0.90-0.94": "Very confident - clear policy violation in code",
      "0.85-0.89": "Confident - likely violation but some context missing",
      "below 0.85": "Do not flag - insufficient evidence"
    }
  },

  "suspiciousPatterns": {
    "description": "Patterns that trigger AI analysis. Add custom patterns here.",
    "patterns": [
      {"pattern": "user(?:_)?(?:data|info|profile)", "category": "data-handling", "description": "User data handling"},
      {"pattern": "(?:store|save|persist|cache).*(?:token|secret|credential)", "category": "credentials", "description": "Credential storage"},
      {"pattern": "(?:share|send|transmit|export).*(?:user|data|personal)", "category": "data-sharing", "description": "Data sharing"},
      {"pattern": "(?:scrape|crawl|extract|harvest)", "category": "scraping", "description": "Data scraping"},
      {"pattern": "(?:automate|bot|automated)", "category": "automation", "description": "Automation"},
      {"pattern": "(?:bulk|mass|batch).*(?:message|post|send)", "category": "bulk-actions", "description": "Bulk messaging"},
      {"pattern": "(?:bypass|circumvent|workaround)", "category": "circumvention", "description": "Policy circumvention"},
      {"pattern": "rate.?limit", "category": "rate-limiting", "description": "Rate limiting"},
      {"pattern": "webhook.*(?:receive|handle|process)", "category": "webhooks", "description": "Webhook handling"},
      {"pattern": "(?:graph|api)\\.facebook\\.com", "category": "api-usage", "description": "Facebook API"},
      {"pattern": "(?:instagram|messenger|whatsapp).*(?:api|send|post)", "category": "platform-api", "description": "Platform API"},
      {"pattern": "(?:createTable|CREATE TABLE|schema\\s*=)", "category": "database", "description": "Database schema"},
      {"pattern": "(?:retention|ttl|expire|delete.*after)", "category": "data-retention", "description": "Data retention"},
      {"pattern": "(?:s3|gcs|blob|storage).*(?:upload|put|store)", "category": "cloud-storage", "description": "Cloud storage"},
      {"pattern": "(?:redis|memcache|cache).*(?:set|store|save)", "category": "caching", "description": "Caching"},

      {"pattern": "CREATE\\s+TABLE.*(?:user|profile|account|customer)", "category": "database-schema", "description": "User table creation"},
      {"pattern": "(?:fb_id|ig_id|facebook_id|instagram_id|psid|user_id)\\s+(?:text|varchar|int|bigint)", "category": "database-schema", "description": "Meta user ID column"},
      {"pattern": "(?:access_token|app_secret|api_key)\\s+(?:text|varchar)", "category": "database-schema", "description": "Token/secret column without encryption"},
      {"pattern": "(?:email|phone|address|location)\\s+(?:text|varchar)", "category": "database-schema", "description": "PII column definition"},
      {"pattern": "model\\s+\\w+.*\\{[^}]*(?:facebook|instagram|messenger|whatsapp)", "category": "orm-schema", "description": "Prisma/ORM model with Meta data"},
      {"pattern": "@db\\.(?:Text|VarChar).*(?:token|secret|key)", "category": "orm-schema", "description": "Prisma credential field"},
      {"pattern": "sequelize\\.define.*(?:user|profile|token)", "category": "orm-schema", "description": "Sequelize model definition"},
      {"pattern": "@Entity.*(?:User|Profile|Token|Account)", "category": "orm-schema", "description": "TypeORM entity definition"},
      {"pattern": "mongoose\\.(?:Schema|model).*(?:user|profile|token)", "category": "orm-schema", "description": "Mongoose schema definition"},
      {"pattern": "(?:INSERT|UPDATE).*(?:access_token|user_data|profile)", "category": "database-ops", "description": "Database write with user data"},
      {"pattern": "(?:conversation|message|chat).*(?:history|log|store)", "category": "data-retention", "description": "Conversation storage"},
      {"pattern": "(?:indefinite|permanent|forever|no.*expir)", "category": "data-retention", "description": "Indefinite storage indicator"},
      {"pattern": "(?:encrypt|decrypt|hash).*(?:token|secret|password)", "category": "credentials", "description": "Credential encryption"},
      {"pattern": "type\\s+(?:User|Profile|Account)\\s*(?:struct|=)", "category": "data-model", "description": "User type/struct definition"},
      {"pattern": "interface\\s+(?:User|Profile|Account|Customer)", "category": "data-model", "description": "User interface definition"}
    ]
  }
}
